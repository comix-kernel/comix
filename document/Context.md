# 执行上下文与切换机制

本文档定义了程序执行上下文（Execution Context）的构成及其在执行流切换（Context Switch）时的操作流程。该机制广泛应用于多任务操作系统中，用于任务调度和资源管理。

## 1. 执行上下文（Execution Context）的构成

执行上下文是 CPU 恢复一个任务（进程或线程）执行所需的所有状态信息的集合。它主要由以下几个部分组成：

| 要素           | 核心内容                                    | 存储位置/管理机制               | 切换需求       |
|----------------|---------------------------------------------|---------------------------------|----------------|
| **CPU 状态**   | 包括通用寄存器、程序计数器、标志寄存器等      | 当前任务的内存区域中           | 每次切换时必需 |
| **地址空间**   | 虚拟地址与物理地址的映射关系                | 特定的地址映射表               | 进程切换时必需 |
| **系统资源**   | 文件描述符、网络连接等资源的引用            | 任务控制块（task control block） | 自动传递       |

### 解释
- **CPU 状态**：包括 CPU 寄存器的内容（如程序计数器、栈指针等），这些内容描述了任务在 CPU 执行期间的当前状态。
- **地址空间**：指任务的内存布局，包括虚拟地址到物理地址的映射。每个任务的地址空间独立，任务切换时需要切换到新任务的地址空间。
- **系统资源**：包括任务持有的资源，如文件、网络连接等。通常由任务控制块管理，切换时资源状态会自动继承。

## 2. 核心数据结构

在任务管理过程中，以下数据结构用于存储任务的状态和相关信息：

| 结构体/寄存器    | 作用                           | 存储内容                          | 所属模块        |
|------------------|--------------------------------|----------------------------------|-----------------|
| **任务控制块 (task control block)** | 管理任务状态、资源、调度信息 | 存储任务的所有信息，包括系统资源、CPU 状态等 | 任务管理        |
| **内存栈**       | 任务的独立执行栈               | 存储上下文信息、局部变量等       | 内存管理        |
| **当前任务指针** | 标识当前执行的任务             | 指向当前任务的任务控制块        | 调度管理        |
| **地址映射信息** | 管理任务的内存映射信息         | 存储任务地址空间的映射信息       | 内存管理        |

### 解释
- **任务控制块 (task control block)**：每个任务都有一个独立的控制块，存储任务的所有状态信息和资源管理信息。
- **内存栈**：任务的执行栈，保存该任务的局部变量和中间计算结果。
- **当前任务指针**：全局指针，始终指向当前正在执行的任务，确保操作系统知道当前哪个任务在 CPU 上执行。

## 3. 执行流切换（Context Switch）的关键操作

当操作系统决定切换当前任务（任务 A）到另一个任务（任务 B）时，执行流切换涉及以下几个关键操作：

| 步骤             | 操作内容                                                                   | 触发条件           | 模块职责           |
|------------------|----------------------------------------------------------------------------|--------------------|--------------------|
| **步骤 1**: 保存与恢复状态 | 1. 将任务 A 的 CPU 寄存器和状态保存到任务 A 的内存区域中。<br>2. 从任务 B 的内存区域恢复 CPU 寄存器和状态。 | 每次任务切换时     | 调度管理/CPU核心   |
| **步骤 2**: 切换地址空间    | 更新任务的内存映射信息，确保任务 B 能访问到其专有的内存空间。             | 进程切换时         | 内存管理           |
| **步骤 3**: 更新当前任务    | 更新当前任务指针，指向任务 B 的控制块，确保调度器知道当前正在执行的是任务 B。 | 每次任务切换时     | 调度管理           |

### 解释
- **步骤 1：保存与恢复状态**：保存当前任务的状态（如寄存器的值），然后恢复新任务的状态。这确保了每个任务在执行流切换后能从它离开时的状态继续运行。
- **步骤 2：切换地址空间**：任务的地址空间必须被切换，以便确保每个任务访问的是它自己的内存区域。通常通过更新地址映射信息来完成这一操作。
- **步骤 3：更新当前任务**：调度器需要更新当前任务指针，指向新任务的控制块，确保下一次调度时可以恢复正确的任务。

---

### 总结

执行上下文切换是多任务操作系统中的关键机制，它确保操作系统能够在多个任务之间切换，保持各任务的独立性和执行状态。通过管理任务的 CPU 状态、地址空间和系统资源，操作系统能够高效地实现任务调度、资源分配与切换。本流程涉及的关键操作包括保存当前任务的状态、切换内存空间和更新任务指针，确保每个任务的状态能够正确恢复。
